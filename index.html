<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Graviti ‚Äì Full Planner</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>
  <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
  <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    .sticky-col { position: sticky; left: 0; z-index: 10; }
    @media print { .no-print { display: none !important; } }
  </style>
</head>
<body class="bg-gray-100">
<div id="root"></div>

<script type="text/babel">
/* ---------- dummy keys ‚Äì replace with real ones ---------- */
const EMAIL_PUBLIC  = "your_public_key";
const EMAIL_SERVICE = "your_service_id";
const EMAIL_TEMPLATE= "your_template_id";

/* ---------- seed data ---------- */
const defaultUsers = [
  { username: "superadmin", password: "admin123", role: "Super Admin", mustChangePassword: true },
  { username: "admin",      password: "admin123", role: "Admin",       mustChangePassword: true },
  { username: "user",       password: "user123",  role: "User",        mustChangePassword: true }
];

const WH_KEY = 'warehouseData';
let warehouse = JSON.parse(localStorage.getItem(WH_KEY) || '{}');
if (!Object.keys(warehouse).length) {
  warehouse = {
    "Paracetamol-500": {
      batchSize: 1000,
      ingredients: {
        "Paracetamol Powder": { needed: 0.45, stock: 200, reorder: 50, lead: 7 },
        "Starch":            { needed: 0.05, stock:  40, reorder: 10, lead: 5 }
      }
    }
  };
  localStorage.setItem(WH_KEY, JSON.stringify(warehouse));
}

const buildMonthData = (year, month) => {
  const days = 30;
  const serial = Math.floor((new Date(year, month - 1, 1) - new Date(1970, 0, 1)) / (1000 * 60 * 60 * 24)) + 25569;
  return [{ process: "Demo Equipment", total: 0, ...Object.fromEntries(Array.from({length: days}, (_, i) => [(serial + i).toString(), 0])) }];
};

const App = () => {
  const [user, setUser] = React.useState(JSON.parse(localStorage.getItem('currentUser')) || null);
  const [users, setUsers] = React.useState(JSON.parse(localStorage.getItem('users')) || defaultUsers);
  const [currentMonth, setCurrentMonth] = React.useState(7);
  const [currentYear, setCurrentYear] = React.useState(2025);
  const [data, setData] = React.useState(buildMonthData(currentYear, currentMonth));
  const [editingProcess, setEditingProcess] = React.useState(null);
  const [editProcessValue, setEditProcessValue] = React.useState('');
  const [mustChangePwd, setMustChangePwd] = React.useState(false);
  const [showSignup, setShowSignup] = React.useState(false);
  const [showUserMgmt, setShowUserMgmt] = React.useState(false);
  const [showWarehouse, setShowWarehouse] = React.useState(false);
  const [showChangePwd, setShowChangePwd] = React.useState(false);
  const [showAddUser, setShowAddUser] = React.useState(false);

  /* helpers */
  const saveData = d => { setData(d); localStorage.setItem(`manufacturingData_${currentYear}_${currentMonth}`, JSON.stringify(d)); };
  const saveUsers = arr => { setUsers(arr); localStorage.setItem('users', JSON.stringify(arr)); };
  const saveWarehouse = () => localStorage.setItem(WH_KEY, JSON.stringify(warehouse));

  /* auth */
  const handleLogin = (un, pw) => {
    const found = users.find(u => u.username === un && u.password === pw);
    if (!found) return alert('Invalid credentials.');
    setUser(found);
    localStorage.setItem('currentUser', JSON.stringify(found));
    if (found.mustChangePassword) setMustChangePwd(true);
  };
  const handleSignup = (un, pw, cpw) => {
    if (pw.length < 8) return alert('‚â•8 chars');
    if (pw !== cpw) return alert('Mismatch');
    if (users.find(u => u.username === un)) return alert('User exists');
    const nu = {username: un, password: pw, role: 'User', mustChangePassword: false};
    saveUsers([...users, nu]);
    alert('Account created!');
    setShowSignup(false);
  };
  const handleLogout = () => { setUser(null); localStorage.removeItem('currentUser'); };

  /* user mgmt */
  const handleRoleChange = (un, newRole) => {
    const updated = users.map(u => u.username === un ? {...u, role: newRole} : u);
    saveUsers(updated);
    if (user.username === un) {
      const nu = {...user, role: newRole};
      setUser(nu);
      localStorage.setItem('currentUser', JSON.stringify(nu));
    }
    alert('Role updated');
  };
  const handleAddUser = (un, role) => {
    if (!un.trim()) return alert('Empty username');
    if (users.find(u => u.username === un)) return alert('User exists');
    const nu = {username: un, password: 'password123', role, mustChangePassword: true};
    saveUsers([...users, nu]);
    alert('User added. Default password: password123');
    setShowAddUser(false);
  };
  const handleDeleteUser = (un) => {
    if (un === 'superadmin') return alert('Cannot delete superadmin');
    const updated = users.filter(u => u.username !== un);
    saveUsers(updated);
    if (user.username === un) handleLogout();
  };
  const handleChangePassword = (oldPw, newPw, confirmPw) => {
    if (oldPw !== user.password) return alert('Wrong old password');
    if (newPw.length < 8) return alert('‚â•8 chars');
    if (newPw !== confirmPw) return alert('Mismatch');
    const updated = users.map(u => u.username === user.username ? {...u, password: newPw, mustChangePassword: false} : u);
    saveUsers(updated);
    const nu = {...user, password: newPw, mustChangePassword: false};
    setUser(nu);
    localStorage.setItem('currentUser', JSON.stringify(nu));
    alert('Password changed');
    setShowChangePwd(false);
    setMustChangePwd(false);
  };

  /* calendar helpers */
  const formatDate = serial => new Date((serial-25569)*86400*1000).toLocaleDateString('en-US', {month:'short', day:'numeric'});
  const monthOptions = Array.from({length:12}, (_,i)=>({value:i+1, label:new Date(2025,i,1).toLocaleString('en-US',{month:'long'})}));
  const yearOptions = Array.from({length:11}, (_,i)=>2020+i);
  const handleMonthChange = (m,y) => {
    setCurrentMonth(m); setCurrentYear(y);
    const days = 30;
    const serial = Math.floor((new Date(y,m-1,1)-new Date(1970,0,1))/(1000*60*60*24))+25569;
    const stored = JSON.parse(localStorage.getItem(`manufacturingData_${y}_${m}`));
    const fallback = buildMonthData(y,m);
    setData(stored || fallback);
  };

  /* data */
  const handleDataEdit = (rowIndex, col, val) => {
    const newData = [...data];
    newData[rowIndex][col] = val;
    if (col !== 'process' && col !== 'total') {
      newData[rowIndex].total = Object.keys(newData[rowIndex])
        .filter(k => !isNaN(k) && k !== 'total')
        .reduce((s,k) => s + (parseFloat(newData[rowIndex][k]) || 0), 0);
    }
    saveData(newData);
    checkStock(newData);
  };
  const checkStock = (schedule) => {
    const planned = {};
    schedule.forEach(row => {
      Object.keys(row)
        .filter(k => !isNaN(k) && k !== 'total' && k !== 'process' && parseFloat(row[k]) > 0)
        .forEach(day => { planned[row.process] = (planned[row.process] || 0) + 1; });
    });
    const short = [];
    for (const [product, obj] of Object.entries(warehouse)) {
      const batches = planned[product] || 0;
      for (const [ing, data] of Object.entries(obj.ingredients)) {
        const needed = batches * data.needed;
        if (needed > data.stock) {
          short.push({product, ingredient: ing, needed, stock: data.stock, shortfall: needed - data.stock, lead: data.lead});
        }
      }
    }
    if (short.length && EMAIL_PUBLIC !== "your_public_key") {
      let body = "Hello Procurement,\n\nThe following materials are short:\n\n";
      short.forEach(s => body += `- ${s.ingredient} for ${s.product}: need ${s.needed.toFixed(2)} kg, have ${s.stock.toFixed(2)} kg (short by ${s.shortfall.toFixed(2)} kg). Lead time: ${s.lead} days.\n`);
      body += "\nPlease order urgently.\n\nThanks!";
      try { window.emailjs.send(EMAIL_SERVICE, EMAIL_TEMPLATE, { message: body }); } catch(e){ /* ignore when keys are dummy */ }
    }
  };

  /* warehouse page */
  const WarehousePage = () => {
    const [wh, setWh] = React.useState(warehouse);
    const [form, setForm] = React.useState({name:'',batchSize:1000,ing:[]});
    const [editMode, setEditMode] = React.useState(false);

    const save = w => { setWh(w); warehouse=w; localStorage.setItem(WH_KEY, JSON.stringify(w)); };
    const addIngredientRow = () => setForm({...form, ing:[...form.ing,{name:'',needed:0,stock:0,reorder:0,lead:0}]});
    const updateIngredient = (idx,field,val) => { const arr=[...form.ing]; arr[idx][field]=parseFloat(val)||0; setForm({...form,ing:arr}); };
    const handleSaveProduct = () => {
      if(!form.name.trim()) return alert('Product name required');
      const obj={}; form.ing.forEach(i=>{if(i.name.trim()) obj[i.name.trim()]={needed:i.needed,stock:i.stock,reorder:i.reorder,lead:i.lead};});
      if(!Object.keys(obj).length) return alert('Add at least one ingredient');
      save({...wh,[form.name.trim()]:{batchSize:parseInt(form.batchSize),ingredients:obj}});
      setForm({name:'',batchSize:1000,ing:[]}); setEditMode(false);
    };
    const delProd = name => { if(confirm(`Delete ${name}?`)){ const w={...wh}; delete w[name]; save(w); } };
    const updateIngField = (prod,ing,field,val) => { const w={...wh}; w[prod].ingredients[ing][field]=parseFloat(val)||0; save(w); };

    return (
      <div className="p-6">
        <h2 className="text-2xl font-bold mb-4">üè≠ Warehouse ‚Äì Stock & Recipe Book</h2>
        {!editMode && <button className="mb-4 px-4 py-2 bg-green-600 text-white rounded" onClick={()=>{setEditMode(true); setForm({name:'',batchSize:1000,ing:[{name:'',needed:0,stock:0,reorder:0,lead:0}]});}}>‚ûï New Product</button>}
        {editMode && (
          <div className="border p-4 mb-4 bg-gray-50 rounded">
            <input placeholder="Product name" value={form.name} onChange={e=>setForm({...form,name:e.target.value})} className="border p-1 mr-2"/>
            <input type="number" placeholder="Batch size" value={form.batchSize} onChange={e=>setForm({...form,batchSize:e.target.value})} className="border p-1 mr-2"/>
            <button className="text-sm px-2 py-1 bg-blue-500 text-white rounded" onClick={addIngredientRow}>+ Ingredient</button>
            {form.ing.map((ing,i)=>(
              <div key={i} className="flex space-x-2 mt-2">
                <input placeholder="Ingredient" value={ing.name} onChange={e=>updateIngredient(i,'name',e.target.value)} className="border p-1 w-1/4"/>
                <input type="number" placeholder="kg/batch" value={ing.needed} onChange={e=>updateIngredient(i,'needed',e.target.value)} className="border p-1 w-1/6"/>
                <input type="number" placeholder="stock" value={ing.stock} onChange={e=>updateIngredient(i,'stock',e.target.value)} className="border p-1 w-1/6"/>
                <input type="number" placeholder="reorder" value={ing.reorder} onChange={e=>updateIngredient(i,'reorder',e.target.value)} className="border p-1 w-1/6"/>
                <input type="number" placeholder="lead days" value={ing.lead} onChange={e=>updateIngredient(i,'lead',e.target.value)} className="border p-1 w-1/6"/>
                <button className="text-sm px-2 bg-red-500 text-white rounded" onClick={()=>setForm({...form,ing:form.ing.filter((_,idx)=>idx!==i)})}>‚úñ</button>
              </div>
            ))}
            <div className="mt-3"><button className="px-3 py-1 bg-green-600 text-white rounded mr-2" onClick={handleSaveProduct}>üíæ Save</button><button className="px-3 py-1 bg-gray-400 text-white rounded" onClick={()=>setEditMode(false)}>Cancel</button></div>
          </div>
        )}
        <table className="w-full bg-white rounded shadow">
          <thead><tr className="bg-blue-600 text-white"><th>Product</th><th>Batch Size</th><th>Ingredient</th><th>kg/batch</th><th>Stock</th><th>Reorder</th><th>Lead(d)</th><th>Action</th></tr></thead>
          <tbody>
            {Object.entries(wh).map(([prod,obj])=>Object.entries(obj.ingredients).map(([ing,dat],idx)=>(
              <tr key={`${prod}-${ing}`}>
                {idx===0 && <td rowSpan={Object.keys(obj.ingredients).length} className="border p-1">{prod}</td>}
                {idx===0 && <td rowSpan={Object.keys(obj.ingredients).length} className="border p-1">{obj.batchSize}</td>}
                <td className="border p-1">{ing}</td><td className="border p-1">{dat.needed}</td>
                <td className="border p-1"><input type="number" value={dat.stock} onChange={e=>updateIngField(prod,ing,'stock',e.target.value)} className="w-20"/></td>
                <td className="border p-1"><input type="number" value={dat.reorder} onChange={e=>updateIngField(prod,ing,'reorder',e.target.value)} className="w-20"/></td>
                <td className="border p-1"><input type="number" value={dat.lead} onChange={e=>updateIngField(prod,ing,'lead',e.target.value)} className="w-20"/></td>
                {idx===0 && <td rowSpan={Object.keys(obj.ingredients).length} className="border p-1"><button className="px-2 py-1 bg-red-600 text-white rounded" onClick={()=>delProd(prod)}>Delete</button></td>}
              </tr>
            )))}
          </tbody>
        </table>
        <button className="mt-4 px-4 py-2 bg-blue-600 text-white rounded" onClick={()=>setShowWarehouse(false)}>‚¨Ö Back to Calendar</button>
      </div>
    );
  };

  /* render */
  return (
    <div className="min-h-screen">
      {!user ? (
        <div className="flex items-center justify-center min-h-screen">
          <div className="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
            <h1 className="text-2xl font-bold text-center mb-4">{user ? 'Password Change' : 'Login'}</h1>
            {!user ? (
              <>
                {!showSignup ? (
                  <div className="space-y-4">
                    <input id="login-username" placeholder="Username" className="w-full p-2 border rounded-md"/>
                    <input id="login-password" type="password" placeholder="Password" className="w-full p-2 border rounded-md"/>
                    <button className="w-full bg-blue-600 text-white p-2 rounded-md" onClick={() => handleLogin(document.getElementById('login-username').value, document.getElementById('login-password').value)}>Login</button>
                    <p className="text-sm text-center">No account? <span onClick={()=>setShowSignup(true)} className="text-blue-600 cursor-pointer">Sign up</span></p>
                  </div>
                ) : (
                  <div className="space-y-4">
                    <input id="signup-username" placeholder="Username" className="w-full p-2 border rounded-md"/>
                    <input id="signup-password" type="password" placeholder="Password" className="w-full p-2 border rounded-md"/>
                    <input id="confirm-password" type="password" placeholder="Confirm" className="w-full p-2 border rounded-md"/>
                    <div className="flex justify-end space-x-2">
                      <button className="px-4 py-2 bg-gray-300 rounded-md" onClick={()=>setShowSignup(false)}>Cancel</button>
                      <button className="px-4 py-2 bg-blue-600 text-white rounded-md"
                              onClick={() => handleSignup(document.getElementById('signup-username').value, document.getElementById('signup-password').value, document.getElementById('confirm-password').value)}>Create</button>
                    </div>
                  </div>
                )}
              </>
            ) : mustChangePwd ? (
              <div className="space-y-4">
                <input id="old-pwd" type="password" placeholder="Old password" className="w-full p-2 border rounded-md"/>
                <input id="new-pwd" type="password" placeholder="New password" className="w-full p-2 border rounded-md"/>
                <input id="confirm-new-pwd" type="password" placeholder="Confirm new" className="w-full p-2 border rounded-md"/>
                <button className="w-full bg-blue-600 text-white p-2 rounded-md" onClick={() => handleChangePassword(document.getElementById('old-pwd').value, document.getElementById('new-pwd').value, document.getElementById('confirm-new-pwd').value)}>Save</button>
              </div>
            ) : null}
          </div>
        </div>
      ) : showWarehouse ? (
        <WarehousePage/>
      ) : (
        <>
          <nav className="bg-blue-600 text-white p-4 flex justify-between items-center">
            <h1 className="text-xl font-bold">Graviti ‚Äì Planner</h1>
            <div className="flex items-center space-x-4">
              <span>Welcome, {user.username} ({user.role})</span>
              {user.role === 'Super Admin' && <button className="bg-white text-blue-600 px-3 py-1 rounded-md" onClick={()=>setShowUserMgmt(true)}>Manage Users</button>}
              <button className="bg-white text-blue-600 px-3 py-1 rounded-md" onClick={() => setShowChangePwd(true)}>Change Password</button>
              <button className="bg-white text-blue-600 px-3 py-1 rounded-md" onClick={handleLogout}>Logout</button>
            </div>
          </nav>

          {showUserMgmt && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white p-6 rounded-lg w-full max-w-2xl max-h-[80vh] overflow-y-auto">
                <h2 className="text-xl font-bold mb-4">User Management</h2>
                <table className="w-full mb-4">
                  <thead><tr className="bg-gray-200"><th>Username</th><th>Role</th><th>Action</th></tr></thead>
                  <tbody>
                    {users.map(u => (
                      <tr key={u.username} className="border-b">
                        <td className="p-2">{u.username}</td>
                        <td className="p-2">
                          <select value={u.role} onChange={e => handleRoleChange(u.username, e.target.value)} className="p-1 border rounded-md">
                            <option value="Super Admin">Super Admin</option>
                            <option value="Admin">Admin</option>
                            <option value="User">User</option>
                          </select>
                        </td>
                        <td className="p-2">
                          <button className="px-2 py-1 bg-red-600 text-white rounded-md" onClick={() => handleDeleteUser(u.username)}><i className="fas fa-trash-alt"/></button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
                <button className="px-4 py-2 bg-blue-600 text-white rounded-md" onClick={()=>setShowAddUser(true)}>Add User</button>
                <button className="px-4 py-2 bg-gray-300 rounded-md ml-2" onClick={()=>setShowUserMgmt(false)}>Close</button>
              </div>
            </div>
          )}

          <div className="container mx-auto p-6">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-2xl font-bold">{new Date(currentYear, currentMonth-1).toLocaleString('en-US', {month: 'long', year: 'numeric'})} Plan</h2>
              <div className="flex space-x-2">
                <select value={currentMonth} onChange={e => handleMonthChange(parseInt(e.target.value), currentYear)} className="p-2 border rounded-md">
                  {Array.from({length:12}, (_,i)=>({value:i+1, label:new Date(2025,i,1).toLocaleString('en-US',{month:'long'})})).map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
                </select>
                <select value={currentYear} onChange={e => handleMonthChange(currentMonth, parseInt(e.target.value))} className="p-2 border rounded-md">
                  {Array.from({length:11}, (_,i)=>2020+i).map(y => <option key={y} value={y}>{y}</option>)}
                </select>
              </div>
            </div>

            {(user.role === 'Super Admin' || user.role === 'Admin') && (
              <div className="mb-4 flex space-x-2">
                <input id="new-equipment" placeholder="Equipment name" className="p-2 border rounded-md flex-grow"/>
                <button className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700" onClick={() => handleAddEquipment(document.getElementById('new-equipment').value)}>Add</button>
              </div>
            )}

            <div className="mb-4 flex space-x-2 no-print">
              <button className="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700" onClick={handleExportCSV}>Export CSV</button>
              <button className="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700" onClick={handleExportPDF}>Export PDF</button>
              <button className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700" onClick={handlePrint}>Print</button>
              <button className="px-4 py-2 bg-teal-600 text-white rounded-md" onClick={()=>setShowWarehouse(true)}>Warehouse</button>
            </div>

            <div className="overflow-x-auto">
              <table className="w-full bg-white rounded-lg shadow-md">
                <thead>
                  <tr className="bg-blue-600 text-white">
                    <th className="p-2 text-left sticky-col bg-blue-600">Process / Equipment</th>
                    {Object.keys(data[0] || {}).filter(k => k !== 'process' && k !== 'total').map(formatDate).map(day => (
                      <th key={day} className="p-2 w-20">{day}</th>
                    ))}
                    <th className="p-2 w-20">Total</th>
                    <th className="p-2 w-12 no-print">Action</th>
                  </tr>
                </thead>
                <tbody>
                  {data.map((row, rowIndex) => (
                    <tr key={row.process} className="border-b">
                      <td className="p-2 sticky-col bg-white">
                        {user.role === 'Super Admin' && editingProcess === rowIndex ? (
                          <div className="flex items-center space-x-2">
                            <input value={editProcessValue} onChange={e => setEditProcessValue(e.target.value)} className="p-1 border rounded-md flex-grow"/>
                            <button className="px-2 py-1 bg-green-600 text-white rounded-md hover:bg-green-700" onClick={() => handleSaveProcess(rowIndex)}><i className="fas fa-check"/></button>
                            <button className="px-2 py-1 bg-gray-300 rounded-md" onClick={() => setEditingProcess(null)}><i className="fas fa-times"/></button>
                          </div>
                        ) : (
                          <div className="flex items-center justify-between">
                            <span onDoubleClick={user.role === 'Super Admin' ? () => { setEditingProcess(rowIndex); setEditProcessValue(row.process); } : null} className="cursor-pointer">{row.process}</span>
                            {user.role === 'Super Admin' && (
                              <div className="flex space-x-1 ml-2">
                                <button className="px-2 py-1 bg-gray-200 rounded-md disabled:opacity-50" disabled={rowIndex === 0} onClick={() => { const d=[...data]; [d[rowIndex-1],d[rowIndex]]=[d[rowIndex],d[rowIndex-1]]; saveData(d); }}><i className="fas fa-arrow-up"/></button>
                                <button className="px-2 py-1 bg-gray-200 rounded-md disabled:opacity-50" disabled={rowIndex === data.length-1} onClick={() => { const d=[...data]; [d[rowIndex],d[rowIndex+1]]=[d[rowIndex+1],d[rowIndex]]; saveData(d); }}><i className="fas fa-arrow-down"/></button>
                              </div>
                            )}
                          </div>
                        )}
                      </td>
                      {Object.keys(row).filter(k => k !== 'process' && k !== 'total').map(col => (
                        <td key={col} className="p-2">
                          {(user.role === 'Super Admin' || user.role === 'Admin') ? (
                            <input value={row[col]} onChange={e => handleDataEdit(rowIndex, col, e.target.value)} className="w-full p-1 border rounded-md"/>
                          ) : row[col]}
                        </td>
                      ))}
                      <td className="p-2">{row.total}</td>
                      <td className="p-2 no-print">
                        {user.role === 'Super Admin' && (
                          <button onClick={() => { const newData = data.filter((_,i)=>i!==rowIndex); saveData(newData); }} className="text-red-600 hover:text-red-800"><i className="fas fa-trash-alt"/></button>
                        )}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </>
      )}
    </div>
  );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
